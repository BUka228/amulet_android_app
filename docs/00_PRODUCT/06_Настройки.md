# Фича «Настройки» (Settings)

## 1. Цели фичи
- Дать пользователю **единую точку управления** всеми важными настройками приложения и амулета.
- Обеспечить **прозрачный контроль приватности, согласий и данных** (telemetry / privacy / export / delete).
- Свести к минимуму количество отдельных экранов: **один главный экран настроек** + несколько детальных экранов только там, где флоу сложный (профиль, приватность, подробные Hugs‑настройки).
- Связать настройки с существующими фичами: практики, объятия, устройства, сессия/аккаунт.


## 2. Основные сущности

- **UserPreferences** (глобальные пользовательские предпочтения)
  - `defaultIntensity`: дефолтная интенсивность вибрации амулета для практик.
  - `defaultBrightness`: дефолтная яркость света амулета для практик.
  - `defaultAudioMode`: аудио‑режим по умолчанию (голос/музыка/без звука) для практик.
  - `goals`, `interests`: цели и интересы пользователя (используются для персонализации рекомендаций).
  - `preferredDurationsSec`: предпочитаемые длительности практик (для фильтров и рекомендаций).
  - `hugsDndEnabled`: глобальный режим DND для «объятий» (см. `SetHugsDndEnabledUseCase`).

- **UserConsents** (согласия пользователя)
  - `analytics`: согласие на аналитику.
  - `usage`: согласие на usage‑телеметрию.
  - `crash`: согласие на сбор crash‑данных.
  - `diagnostics`: согласие на диагностические события.
  - Используется в телеметрии (`TelemetryRepository`) и сессионном контексте (`UserSessionContext.LoggedIn`).

- **Настройки «Объятий» (HugsSettings)**
  - Глобальный DND для объятий (работает через `UserPreferences.hugsDndEnabled`).
  - Тихие часы для объятий: `quietHoursStartMinutes`, `quietHoursEndMinutes`.
  - Anti‑spam лимиты: `maxHugsPerHour`.
  - Статус mute для текущей пары: `muted`.
  - Управление связью пары: возможность разорвать текущую пару (`blockPairUseCase`).

- **Настройки устройств (Device Settings)**
  - Имя устройства, версия прошивки, статус OTA.
  - Яркость и жесты амулета на уровне конкретного устройства.
  - Привязка/отвязка устройства от аккаунта, передача другому пользователю.
  - Управляется в `:feature:devices` (экран(ы) деталей устройства, не дублируются в Settings, туда только ведёт ссылка).

- **Аккаунт и профиль (Profile / Account)**
  - Имя/ник, аватар.
  - Часовой пояс, (в перспективе — язык интерфейса).
  - Управление сессией: logout, потенциально — смена пароля/e‑mail через auth‑флоу.

- **Приватность и данные (Privacy)**
  - Управление согласиями (`UserConsents`).
  - Флоу запроса экспорта данных и удаления аккаунта (реализуется через `:data:privacy` / `PrivacyRepository`).


## 3. Высокоуровневый UX‑флоу

1. **Вход в настройки**
   - Пользователь тапаeт по иконке шестерёнки в нижней навигации (`BottomNavItem route = "settings/main"`).
   - Открывается главный экран настроек `settings/main`.

2. **Обзор ключевых настроек на одном экране**
   - Пользователь видит секции:
     - «Профиль и аккаунт»
     - «Устройство и амулет»
     - «Практики и амулет»
     - «Объятия и пары»
     - «Уведомления и режимы тишины»
     - «Приватность и данные»
     - «Безопасность и вход»
     - «О приложении»
   - Большинство тумблеров и базовых настроек доступны прямо здесь без переходов.

3. **Переход в детальные настройки, только если необходимо**
   - Для сложных флоу есть отдельные экраны:
     - Профиль (`settings/profile`).
     - Предпочтения практик (`settings/practices`) — опционально, при расширении логики.
     - Приватность и данные (`settings/privacy`).
     - Подробные настройки объятий (`hugs/settings`) и устройств (`devices/...`).

4. **Связь настроек с поведением приложения**
   - Изменение `UserPreferences` влияет на дефолтные параметры экрана практик/сессий.
   - Изменение Hugs DND / тихих часов немедленно влияет на доставку/отображение «объятий».
   - Изменение согласий (`UserConsents`) немедленно влияет на телеметрию (см. `Logging & Telemetry`).
   - Logout / удаление аккаунта очищают локальные данные согласно политике безопасности.


## 4. Структура экранов

### 4.1. Экран «Настройки» (settings/main)

**Цель экрана**
- Быть единой «домашней страницей» для всех настроек приложения и амулета.
- Дать быстрый доступ к ключевым тумблерам и разделам без глубокой иерархии.
- Не перегружать пользователя — максимум информации и контроля на одном экране.

**Основные секции и элементы**

- **Профиль и аккаунт**
  - Строка‑настройка: «Профиль» → `settings/profile`.
    - Сабтекст: текущее имя/ник пользователя.
  - Строка‑настройка: «Выйти из аккаунта»
    - Показывает подтверждающий диалог.

- **Устройство и амулет**
  - Строка‑настройка: «Устройства»
    - Переход в `devicesGraph` (например, `devices/list`) с возможностью выбрать устройство и открыть его детали.
  - (Опционально) Строка‑настройка: «Настройки моего амулета»
    - Быстрый переход к деталям основного устройства или к его настройкам яркости/жестов.

- **Практики и амулет**
  - Слайдер/контрол: «Интенсивность по умолчанию»
    - Связан с `UserPreferences.defaultIntensity`.
  - Слайдер/контрол: «Яркость по умолчанию»
    - Связан с `UserPreferences.defaultBrightness`.
  - Выпадающий список / сегмент‑контрол: «Аудио по умолчанию»
    - Связан с `UserPreferences.defaultAudioMode`.
  - Строка‑настройка: «Цели и интересы» → `settings/practices` (детальный экран, см. ниже) или простое диалоговое окно при MVP.

- **Объятия и пары**
  - Тумблер: «Не беспокоить в объятиях» (DND)
    - Связан с `UserPreferences.hugsDndEnabled` через `SetHugsDndEnabledUseCase`.
    - Подпись поясняет, что амулет не будет реагировать на входящие объятия, но нотификации на телефоне останутся.
  - Строка‑настройка: «Подробные настройки объятий»
    - Переход на `hugs/settings` (`HugsSettingsRoute`).

- **Уведомления и режимы тишины**
  - (Опционально) Тумблер: «Push‑уведомления о событиях в приложении»
    - Может приводить к системным настройкам уведомлений.
  - Строка‑настройка: «Тихие часы для объятий»
    - В summary показывается текущий интервал (`22:00–08:00` или «Выключено»), нажатие ведёт на `hugs/settings` к секции тихих часов.

- **Приватность и данные**
  - Тумблеры/чипы по `UserConsents`:
    - «Аналитика», «Использование», «Краши», «Диагностика».
  - Строка‑настройка: «Управление данными и приватностью» → `settings/privacy`.

- **Безопасность и вход**
  - (Если реализовано) Строка: «PIN/биометрия для входа» → экран настройки локальной защиты входа.

- **О приложении**
  - Строка: «О приложении»
    - Показывает версию, ссылки на политику конфиденциальности, условия использования и т. п.

**Интеракции и поведение**
- Все изменения тумблеров/слайдеров сохраняются либо немедленно (с debounce), либо через локальное состояние + единое сохранение при уходе с экрана (решение остаётся за реализацией, но продуктово важно, чтобы пользователь не терял изменения).
- При ошибках сохранения настроек показывается Snackbar/inline‑баннер, но локальные значения не «откатываются» неожиданно без объяснения.


### 4.2. Экран «Профиль» (settings/profile)

**Цели экрана**
- Дать пользователю возможность редактировать базовые данные профиля, которые используются по всему приложению.
- Ясно показать связь между профилем и персонализацией (имя, аватар, часовой пояс).

**Основные элементы**
- Hero‑блок с аватаром и именем:
  - Аватар (кружок) + кнопка «Изменить».
  - Поле «Имя/ник».
- Блок «Основная информация»:
  - E‑mail (read‑only или с флоу изменения через auth‑экран).
  - Часовой пояс (drop‑down / picker).
  - (Опционально) Язык интерфейса.
- Блок «Управление аккаунтом»:
  - Ссылка «Изменить пароль» (если релевантно).
  - Кнопка «Выйти» (дублирует опцию с главного экрана настроек, но в более контекстном месте).

**Интеракции**
- Сохранение изменений по явной кнопке «Сохранить».
- Валидация полей (например, имя не пустое, корректный формат email при изменении и т. п.).


### 4.3. Экран «Предпочтения практик» (settings/practices) — опционально

**Роль в навигации**
- Дополнительный экран, если базовых контролов на `settings/main` не хватает.
- Открывается из секции «Практики и амулет».

**Основные элементы**
- Блок «Цели»:
  - Список чипов (сон, стресс, энергия, фокус и др.).
  - Возможность выбрать несколько.
- Блок «Интересы»:
  - Теги/чипы по типам практик (дыхание, медитации, звук и т. д.).
- Блок «Предпочитаемая длительность»:
  - Чипы: «≤5 мин», «5–15 мин», «>15 мин».
  - Маппятся на `preferredDurationsSec`.

**Интеракции**
- Выбор/отмена выбора чипов с немедленным применением.
- Пояснения, что эти настройки влияют на рекомендации в «Доме практик» и каталоге.


### 4.4. Экран «Приватность и данные» (settings/privacy)

**Цели экрана**
- Дать пользователю понятный контроль над тем, какие данные собираются и как используются.
- Обеспечить доступ к операциям экспорта и удаления аккаунта.

**Основные блоки**

- **Согласия (Consents)**
  - Список переключателей:
    - «Аналитика»
    - «Usage‑данные»
    - «Отчёты о сбоях (Crash)»
    - «Диагностика»
  - Под каждым тумблером — краткое пояснение (1–2 строки), что даёт включение.
  - Изменения отражаются в `UserConsents` и напрямую влияют на поведение `TelemetryRepository` и логирования.

- **Управление данными**
  - Кнопка: «Запросить экспорт данных»
    - Открывает диалог с подтверждением и кратким описанием процесса.
  - Кнопка: «Удалить аккаунт и данные»
    - Ярко выделена (например, в error‑стиле).
    - Подробный диалог подтверждения с перечислением последствий (потеря истории практик, "объятий", профиля и т. п.).

**Интеракции и состояния**
- При смене согласий — возможен небольшой инфо‑баннер, что изменения вступят в силу немедленно.
- При запуске экспорта/удаления — отображение состояния (в процессе / завершено / ошибка).


### 4.5. Экран «Настройки объятий» (hugs/settings)

> Реализация уже существует (`HugsSettingsRoute` / `HugsSettingsViewModel`), ниже — продуктовая рамка, как этот экран встраивается в общий граф настроек.

**Роль в навигации**
- Детальный экран настроек для фичи «Объятия».
- Открывается из секции «Объятия и пары» на `settings/main`.

**Основные блоки (на основе текущей реализации)**

- **Режимы работы**
  - Глобальный DND для объятий (тумблер, завязан на `UserPreferences.hugsDndEnabled`).
  - Тихие часы:
    - Поле «С» (время начала, `quietHoursStartMinutes`).
    - Поле «До» (время окончания, `quietHoursEndMinutes`).

- **Ограничения (Anti‑Spam)**
  - Поле для `maxHugsPerHour` с пояснением, что это ограничивает количество объятий в единицу времени.

- **Управление парой**
  - Тумблер «Заглушить объятия от этой пары» (`muted`).
  - Кнопка «Разорвать пару» с диалогом подтверждения.

**Интеграция с `settings/main`**
- На главном экране настроек показывается лишь краткий DND‑тумблер и ссылка; все детальные параметры остаются на `hugs/settings`.


## 5. Enterprise‑аспекты UI/UX

- **Минимизация экранов:**
  - Один основной экран `settings/main` с максимальным количеством полезных тумблеров и ссылок.
  - Отдельные экраны только там, где флоу сложный или потенциально опасный (профиль, приватность, Hugs‑ограничения, устройство).

- **Прозрачность приватности:**
  - Все настройки, связанные с данными и телеметрией, собраны в одном месте («Приватность и данные»).
  - Каждое согласие сопровождается коротким, понятным текстом.

- **Ясные состояния и ошибки:**
  - Для длительных операций (экспорт/удаление аккаунта) предусмотрены отображения прогресса и состояния.
  - Для ошибок сохранения настроек используются понятные сообщения, без утечки PII.

- **Соответствие архитектуре:**
  - Настройки не лезут напрямую в `DataStore`/`Room` из UI; используются доменные use‑cases и репозитории.
  - Глобальные prefs (`UserPreferences`, `UserConsents`) остаются единственным источником правды для разных фич.


## 6. Интеграция с другими фичами

- **Практики**
  - Используют `UserPreferences` для дефолтных значений интенсивности, яркости, аудио.
  - Могут учитывать `goals`, `interests`, `preferredDurationsSec` для рекомендаций и сортировки.

- **Объятия (Hugs)**
  - Уважают глобальный DND и тихие часы из настроек.
  - Anti‑spam лимиты из `HugsSettings` влияют на бизнес‑логику отправки «объятий».

- **Устройства (Devices)**
  - Глобальный экран настроек даёт вход в управление устройствами; сами подробные настройки реализуются в `:feature:devices`.

- **Телеметрия и логирование**
  - `UserConsents` напрямую влияют на то, какие события отправляются (`Logging & Telemetry`).
  - Вся логика проверки согласий сосредоточена в одном месте (репозитории/сессия), UI только меняет флажки.

- **Auth и сессия**
  - Logout и удаление аккаунта используют общий механизм `AuthRepository` и `UserSessionManager`.
  - Состояние согласий и prefs привязано к текущему пользователю, и при logout должно очищаться по политике безопасности.
